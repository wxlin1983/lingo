<!DOCTYPE html>
<html>
<head>
    <title>Quiz Question {{ current_index + 1 }}</title>
    <style>
        /* ç°¡å–®çš„æ¨£å¼ï¼Œç”¨æ–¼çªå‡ºé¡¯ç¤ºç­”æ¡ˆ */
        .correct-text { color: green; font-weight: bold; }
        .incorrect-text { color: red; }
    </style>
</head>
<body>
    <h1>Question {{ current_index + 1 }} / {{ total_questions }}</h1>
    
    <h2>Word: <strong>{{ word }}</strong></h2>

    <div id="quiz-form-container">
        <form id="quiz-form">
            <input type="hidden" name="word" value="{{ word }}">
            <input type="hidden" name="current_index" value="{{ current_index }}">

            {% set is_correctly_answered = answer_record and answer_record.is_correct %}
            
            {% for option in options %}
                <div>
                    <input 
                        type="radio" 
                        id="option-{{ loop.index }}" 
                        name="answer" 
                        value="{{ option }}"
                        data-option-value="{{ option }}"
                        {% if answer_record and answer_record.user_answer == option %} 
                            checked 
                        {% endif %}
                        
                        {# åªæœ‰åœ¨å·²ç¶“æ­£ç¢ºå›ç­”æ™‚æ‰ç¦ç”¨é¸é … #}
                        {% if is_correctly_answered %} 
                            disabled 
                        {% endif %}
                    >
                    <label for="option-{{ loop.index }}">{{ option }}</label>
                    
                    {# é¡¯ç¤ºä½œç­”æ¨™è¨˜ #}
                    <span class="feedback-icon" id="feedback-{{ loop.index }}">
                        {% if answer_record %}
                            {# åªæœ‰åœ¨å˜—è©¦éå¾Œæ‰é¡¯ç¤º #}
                            {% if answer_record.user_answer == option %}
                                {% if answer_record.is_correct %}
                                    <strong class="correct-text">(Your Correct Answer)</strong> ğŸŸ¢
                                {% else %}
                                    <strong class="incorrect-text">(Your Incorrect Answer)</strong> ğŸ”´
                                {% endif %}
                            {% elif option == correct_translation %}
                                {# é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ (åœ¨å›ç­”éŒ¯èª¤æˆ–æ­£ç¢ºæ™‚) #}
                                <strong class="correct-text"> (Correct) </strong> âœ…
                            {% endif %}
                        {% endif %}
                    </span>
                </div>
            {% endfor %}

            <br>
            <button type="submit" id="submit-btn" 
                {% if is_correctly_answered %} disabled {% endif %}
            >
                Submit Answer
            </button>
            <p id="submission-message" style="margin-top: 10px;"></p>
        </form>
    </div>

    <div style="margin-top: 20px;">
        {% if not is_first_question %}
            <a href="/quiz/{{ current_index - 1 }}">
                <button>â¬…ï¸ Previous</button>
            </a>
        {% endif %}

        {% if not is_last_question %}
            <a href="/quiz/{{ current_index + 1 }}">
                <button>Next â¡ï¸</button>
            </a>
        {% else %}
            <a href="/result">
                <button>Finish Quiz ğŸ‰</button>
            </a>
        {% endif %}
    </div>

    <script>
        document.getElementById('quiz-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const form = e.target;
            const submitButton = document.getElementById('submit-btn');
            const messageDisplay = document.getElementById('submission-message');
            const radioInputs = document.querySelectorAll('input[name="answer"]');

            const selectedInput = document.querySelector('input[name="answer"]:checked');
            if (!selectedInput) {
                alert('Please select an answer before submitting.');
                return;
            }

            const formData = new FormData(form);
            const data = new URLSearchParams(formData).toString();

            try {
                const response = await fetch('/submit_answer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: data
                });

                const result = await response.json();

                if (response.ok) {
                    // 1. è™•ç†æˆåŠŸæäº¤
                    
                    // 2. ç¦ç”¨æ‰€æœ‰é¸é …å’Œæäº¤æŒ‰éˆ•
                    submitButton.disabled = true;
                    radioInputs.forEach(input => input.disabled = true);
                    
                    // 3. é¡¯ç¤ºåé¥‹è¨Šæ¯
                    if (result.is_correct) {
                        messageDisplay.className = 'correct-text';
                        messageDisplay.textContent = 'ğŸ‰ Correct! You can now move to the next question.';
                    } else {
                        messageDisplay.className = 'incorrect-text';
                        messageDisplay.textContent = `âŒ Incorrect. The correct answer was: ${result.correct_answer}.`;
                    }

                    // 4. æ¨™è¨˜é¸é … (ä½¿ç”¨ data-option-value æŸ¥æ‰¾é¸é …)
                    radioInputs.forEach((input, index) => {
                        const optionValue = input.getAttribute('data-option-value');
                        const feedbackSpan = document.getElementById(`feedback-${index + 1}`);
                        feedbackSpan.innerHTML = ''; // æ¸…é™¤ç¾æœ‰çš„ Jinja2 æ¨™è¨˜ (å¦‚æœæœ‰)

                        if (optionValue === result.user_answer) {
                            input.checked = true; // ç¢ºä¿é¸ä¸­çš„é¸é …è¢«æ¨™è¨˜
                            if (result.is_correct) {
                                feedbackSpan.innerHTML = '<strong class="correct-text">(Your Correct Answer)</strong> ğŸŸ¢';
                            } else {
                                feedbackSpan.innerHTML = '<strong class="incorrect-text">(Your Incorrect Answer)</strong> ğŸ”´';
                            }
                        } else if (optionValue === result.correct_answer) {
                            feedbackSpan.innerHTML = '<strong class="correct-text"> (Correct) </strong> âœ…';
                        }
                    });

                } else {
                    // è™•ç†æœå‹™å™¨è¿”å›çš„éŒ¯èª¤ (ä¾‹å¦‚ï¼Œé‡è¤‡æäº¤)
                    messageDisplay.className = 'incorrect-text';
                    messageDisplay.textContent = 'Error submitting answer: ' + (result.error || 'Server error.');
                }
            } catch (error) {
                messageDisplay.className = 'incorrect-text';
                messageDisplay.textContent = 'Network error: Could not connect to the server.';
                console.error('Fetch error:', error);
            }
        });
    </script>
</body>
</html>